package maintenance;

import java.sql.SQLException;
import java.util.*;


public class AccountMaintenance{
	private static final String QUERY = "SELECT * FROM ";
	private static final int NUMBER_OF_COLUMNS = 3;
	private static Map<String, Account> accounts;
	private static DataBaseCRUD dbCrud;
	
	public AccountMaintenance(String user, String password) throws SQLException {
		dbCrud = new DataBaseCRUD(user, password);
	}

	public static void updateAccounts(String tableName, String tableUpdate) throws SQLException {
		//Mapper ut accounts
		accounts = getAccounts(tableName);
		
		//Query databasen, henter ut data, legger det i en list
		List<String> content = dbCrud.dbQuery(QUERY + tableName);
		
		LinkedList<AccountUpdate> accountUpdates = (LinkedList<AccountUpdate>) makeNewAccountUpdates(content, NUMBER_OF_COLUMNS);

		for (AccountUpdate key : accountUpdates) {
			if (accounts.containsKey(String.valueOf(key.getAccountNumber()))) {
				
				applyStrUpdates(key);
				
			}else {
				int checkAccNumber = key.getAccountNumber();
				if (String.valueOf(checkAccNumber).length() == 8) {
					accounts.put(
							String.valueOf(checkAccNumber), 
							new Account(
										key.getAccountNumber(),
										Integer.valueOf(key.getStrUpdate()),
										key.getStrValue()
										)
							);
				}
			}
		}//End foreach
		dbCrud.updateValuesInDB(accounts, tableName);
	}
	private static void applyStrUpdates(AccountUpdate key) {
		//Variabelen nedenfor blir brukt hyppig under de igjen:
		String getUpdateValueAtKey = key.getStrUpdate();
		double getValueAtKey = key.getStrValue();
		String IntToString = String.valueOf(key.getAccountNumber());
		
		if (getUpdateValueAtKey.equals("b+")) {
			accounts.get(IntToString).increaseBalance((int) getValueAtKey);
		}
		else if (getUpdateValueAtKey.equals("b-")) {
			accounts.get(IntToString).decreaseBalance((int) getValueAtKey);
		}
		else if (getUpdateValueAtKey.equals("i+")) {
			accounts.get(IntToString).increaseInterest(getValueAtKey);
		}
		else if (getUpdateValueAtKey.equals("i-")) {
			accounts.get(IntToString).decreaseInterest(getValueAtKey);
		}
		else if (getUpdateValueAtKey.equals("b")) {
			accounts.get(IntToString).setBalance((int) getValueAtKey);
		}
		else if (getUpdateValueAtKey.equals("i")) {
			accounts.get(IntToString).setInterest(getValueAtKey);
		}
		else if (getUpdateValueAtKey.equals("")) {
			System.out.println("No update value found!");
		}

	}
	
	public static Map<String, Account> getAccounts(String tableName) throws SQLException {
		return dbCrud.getAccounts(tableName);
	}
	
	public static Account getAccount(String tableName, String accountNumber) throws SQLException {
		String getAccQuery = tableName + " WHERE ACCOUNTNUMBER = " + accountNumber;
		
		List<String> accountData = dbCrud.dbQuery(QUERY + getAccQuery);
		
		Account account = new Account(
				Integer.valueOf(accountData.get(0)),
				Integer.valueOf(accountData.get(1)), 
				Double.valueOf(accountData.get(2))
				);
		
		return account;
	}
	
}
